<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mini SIEM Dashboard</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1 { margin-bottom: 0.5rem; }
    table { border-collapse: collapse; margin: 1rem 0; min-width: 300px; }
    th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: left; }
    th { background: #eee; }
    .small { font-size: 0.85rem; color: #555; }
  </style>
</head>
<body>
  <h1>Mini SIEM Dashboard</h1>
  <div class="small">Data from traffic.log</div>

  <h2>Top Source IPs</h2>
  <table id="ipTable">
    <thead><tr><th>IP</th><th>Count</th><th>Last Seen (UTC)</th></tr></thead>
    <tbody></tbody>
  </table>

  <h2>Top Destination Ports</h2>
  <table id="portTable">
    <thead><tr><th>Path</th><th>Count</th></tr></thead>
    <tbody></tbody>
  </table>

  <h2>Recent Attacks</h2>
  <table id="attackTable">
    <thead><tr><th>Time (UTC)</th><th>IP</th><th>Path</th><th>Method</th></tr></thead>
    <tbody></tbody>
  </table>

<script>
const API_BASE = "https://signaltrap.fly.dev";

  const ALERT_THRESHOLD = 10; 

  async function loadStats() {
    const res = await fetch(`${API_BASE}/api/stats`);
    const data = await res.json();

    const ipBody = document.querySelector('#ipTable tbody');
    const portBody = document.querySelector('#portTable tbody');
    const attackBody = document.querySelector('#attackTable tbody');
    ipBody.innerHTML = '';
    portBody.innerHTML = '';
    attackBody.innerHTML = '';

    // Handle topIPs array format
    const topIPs = data.topIPs || [];
    topIPs.forEach(item => {
      const tr = document.createElement('tr');
      if (item.count >= ALERT_THRESHOLD) {
        tr.style.backgroundColor = '#fdd';
      }
      const tdIp = document.createElement('td');
      const tdCount = document.createElement('td');
      const tdLast = document.createElement('td');
      tdIp.textContent = item.ip;
      tdCount.textContent = item.count;
      tdLast.textContent = item.last_seen || '';
      tr.append(tdIp, tdCount, tdLast);
      ipBody.appendChild(tr);
    });

    // Handle topPaths array format - display as "ports"
    const topPaths = data.topPaths || [];
    topPaths.forEach(item => {
      const tr = document.createElement('tr');
      const tdPort = document.createElement('td');
      const tdCount = document.createElement('td');
      tdPort.textContent = item.path;
      tdCount.textContent = item.count;
      tr.append(tdPort, tdCount);
      portBody.appendChild(tr);
    });

    // Display recent attacks (last 20)
    const recentAttacks = data.recentAttacks || [];
    recentAttacks.slice(0, 20).forEach(attack => {
      const tr = document.createElement('tr');
      const tdTime = document.createElement('td');
      const tdIp = document.createElement('td');
      const tdPath = document.createElement('td');
      const tdMethod = document.createElement('td');
      
      // Format timestamp to show just time
      const timestamp = new Date(attack.timestamp);
      tdTime.textContent = timestamp.toISOString().substring(11, 19);
      tdIp.textContent = attack.ip;
      tdPath.textContent = attack.path;
      tdMethod.textContent = attack.method;
      
      tr.append(tdTime, tdIp, tdPath, tdMethod);
      attackBody.appendChild(tr);
    });
  }

  loadStats();
  setInterval(loadStats, 5000);
</script>


</body>
</html>

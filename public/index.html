<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mini SIEM Dashboard</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f7f7f7; }
        h1 { color: #333; }
        .stats { margin-bottom: 2em; }
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2em;
            margin-bottom: 2em;
        }
        @media (max-width: 900px) {
            .analytics-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
        }
        .card {
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 1em;
            min-height: 260px;
            max-height: 320px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .card > h2 {
            margin-bottom: 0.5em;
        }
        .card > #geoMap,
        .card > canvas {
            flex-grow: 1;
            width: 100% !important;
            height: 220px !important;
            min-height: 180px;
            max-height: 260px;
            margin: 0 auto;
        }
        #geoMap,
        #eventsOverTimeChart,
        #topIPsChart,
        #protocolChart {
            width: 100% !important;
            height: 220px !important;
            min-height: 180px;
            max-height: 260px;
            margin: 0 auto;
        }
        table { border-collapse: collapse; width: 100%; margin-bottom: 1em; font-size: 0.95em; }
        th, td { border: 1px solid #ccc; padding: 0.4em 0.6em; text-align: left; }
        th { background: #eee; position: sticky; top: 0; z-index: 2; }
        .recent-events {
            max-height: 350px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        #recentEvents tbody tr:nth-child(even) { background: #f2f2f2; }
        #recentEvents tbody tr:hover { background: #dbeafe; }
        #recentEvents td { font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace; font-size: 0.97em; }
        .compact-table th, .compact-table td { padding: 0.3em 0.5em; }
    </style>
</head>
<body>
    <h1>Mini SIEM Dashboard</h1>
    <div class="honeypot-info" style="background:#e0f2fe;border:1px solid #38bdf8;padding:1em;margin-bottom:1.5em;border-radius:8px;">
        <strong>Send traffic to:</strong>
        <span style="font-family:monospace;color:#0ea5e9">https://backend-weathered-voice-4887.fly.dev:<b>21, 5022, 53389, 53306, 56379, 57017, 8080, 5000</b></span>
        <br>
        <span style="font-size:0.95em;color:#64748b">Events sent to these ports will appear in real time on this dashboard.</span>
    </div>
    <details class="project-architecture" style="background:#f1f5f9;border:1px solid #94a3b8;padding:1em;margin-bottom:2em;border-radius:8px;">
        <summary style="font-weight:bold;font-size:1.1em;cursor:pointer;">Project Architecture</summary>
        <ul style="margin-top:0.5em;margin-bottom:0.5em;">
            <li><b>Backend:</b> Python Flask app (deployed on Fly.io) logs events from honeypot ports and exposes <code>/api/stats</code> for dashboard data.</li>
            <li><b>Frontend:</b> Static dashboard (hosted on Netlify) fetches stats from backend, displays analytics, and visualizes geo-IP data on a map.</li>
            <li><b>Geo-IP:</b> All IP geolocation is performed server-side using the ipwho.is API, with results cached for efficiency.</li>
            <li><b>Ports:</b> SSH (5022), FTP (21/5021), RDP (53389), MySQL (53306), Redis (56379), MongoDB (57017), HTTP (8080/5000).</li>
        </ul>
        <span style="font-size:0.95em;color:#64748b">Designed for portfolio demonstration and real-time SIEM analytics.</span>
    </details>
    <div class="stats" style="display: flex; gap: 2em; align-items: center; margin-bottom: 2em;">
        <div style="flex: 1; font-size: 1.1em;">
            <strong>Total Events:</strong> <span id="totalEvents">0</span>
        </div>
        <div style="flex: 1; font-size: 1.1em;">
            <strong>Last 24 Hours:</strong> <span id="last24h">0</span>
        </div>
    </div>
    <section class="analytics-grid">
        <div class="card">
            <h2>Geo-IP Map</h2>
            <div id="geoMap" style="height: 100%; width: 100%;"></div>
        </div>
        <div class="card">
            <h2>Events Over Time</h2>
            <canvas id="eventsOverTimeChart"></canvas>
        </div>
        <div class="card">
            <h2>Top IPs</h2>
            <canvas id="topIPsChart"></canvas>
        </div>
        <div class="card">
            <h2>Events by Protocol</h2>
            <canvas id="protocolChart"></canvas>
        </div>
    </section>
    <div style="display: flex; gap: 2em; align-items: flex-start; margin-bottom: 2em;">
        <div style="flex: 1;">
            <h2>Top IPs (Table)</h2>
            <table id="topIPs">
                <thead><tr><th>IP</th><th>Count</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="flex: 1;">
            <h2>Top Ports</h2>
            <table id="topPorts">
                <thead><tr><th>Port</th><th>Count</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <h2>Recent Events</h2>
    <div class="recent-events">
    <table id="recentEvents" class="compact-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>IP</th>
                    <th>Port</th>
                    <th>Src Port</th>
                    <th>Protocol</th>
                    <th>Type</th>
                    <th>Message</th>
                    <th>User Agent</th>
                    <th>Banner Sent</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        // Chart.js chart objects
        let eventsOverTimeChart, topIPsChart, protocolChart;
        let geoMap, geoMarkers = [];

        // Simple in-memory cache for IP geolocation
        const ipGeoCache = {};

        async function fetchGeo(ip) {
            // No longer used. All geo lookups are done in the backend.
            return null;
        }

        async function buildGeoMarkers(events) {
            // Use geoIPs from backend for map markers
            const markers = [];
            if (window.latestGeoIPs && Array.isArray(window.latestGeoIPs)) {
                window.latestGeoIPs.forEach(entry => {
                    const ip = entry.ip;
                    const lat = entry.lat;
                    const lon = entry.lon;
                    const country = entry.country;
                    const count = entry.count;
                    if (lat != null && lon != null) {
                        const popup = `<strong>IP:</strong> ${ip}<br>` +
                            (country ? `<strong>Country:</strong> ${country}<br>` : "<span style='color:#e11d48'>Unknown location</span><br>") +
                            `<strong>Events:</strong> ${count}`;
                        markers.push({
                            lat,
                            lng: lon,
                            popup
                        });
                    }
                });
            }
            return markers;
        }

        function groupEventsByMinute(events) {
            // Group events by minute (UTC)
            const buckets = {};
            events.forEach(ev => {
                if (!ev.timestamp) return;
                const d = new Date(ev.timestamp);
                const key = d.getUTCFullYear() + '-' + (d.getUTCMonth()+1).toString().padStart(2,'0') + '-' + d.getUTCDate().toString().padStart(2,'0') + ' ' + d.getUTCHours().toString().padStart(2,'0') + ':' + d.getUTCMinutes().toString().padStart(2,'0');
                buckets[key] = (buckets[key] || 0) + 1;
            });
            const labels = Object.keys(buckets).sort();
            const data = labels.map(l => buckets[l]);
            return { labels, data };
        }

        function groupEventsByProtocol(events) {
            const counts = {};
            events.forEach(ev => {
                const proto = ev.protocol || "Unknown";
                counts[proto] = (counts[proto] || 0) + 1;
            });
            const labels = Object.keys(counts);
            const data = labels.map(l => counts[l]);
            return { labels, data };
        }

        function updateEventsOverTimeChart(events) {
            const { labels, data } = groupEventsByMinute(events);
            if (!eventsOverTimeChart) {
                const ctx = document.getElementById('eventsOverTimeChart').getContext('2d');
                eventsOverTimeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Events',
                            data,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37,99,235,0.1)',
                            fill: true,
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { x: { title: { display: true, text: 'Time (UTC)' } }, y: { title: { display: true, text: 'Events' }, beginAtZero: true } }
                    }
                });
            } else {
                eventsOverTimeChart.data.labels = labels;
                eventsOverTimeChart.data.datasets[0].data = data;
                eventsOverTimeChart.update();
            }
            if (labels.length === 0) {
                document.getElementById('eventsOverTimeChart').parentElement.innerHTML = '<div style="padding:2em;text-align:center;color:#888;">No data yet</div>';
            }
        }

        function updateTopIPsChart(topIPs) {
            const labels = topIPs.slice(0,10).map(ip => ip.ip);
            const data = topIPs.slice(0,10).map(ip => ip.count);
            if (!topIPsChart) {
                const ctx = document.getElementById('topIPsChart').getContext('2d');
                topIPsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Events',
                            data,
                            backgroundColor: '#22d3ee'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { x: { title: { display: true, text: 'Events' }, beginAtZero: true }, y: { title: { display: true, text: 'IP' } } }
                    }
                });
            } else {
                topIPsChart.data.labels = labels;
                topIPsChart.data.datasets[0].data = data;
                topIPsChart.update();
            }
            if (labels.length === 0) {
                document.getElementById('topIPsChart').parentElement.innerHTML = '<div style="padding:2em;text-align:center;color:#888;">No data yet</div>';
            }
        }

        function updateProtocolChart(events) {
            const { labels, data } = groupEventsByProtocol(events);
            if (!protocolChart) {
                const ctx = document.getElementById('protocolChart').getContext('2d');
                protocolChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Events',
                            data,
                            backgroundColor: ['#2563eb','#22d3ee','#f59e42','#f43f5e','#10b981','#a78bfa','#fbbf24','#eab308']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            } else {
                protocolChart.data.labels = labels;
                protocolChart.data.datasets[0].data = data;
                protocolChart.update();
            }
            if (labels.length === 0) {
                document.getElementById('protocolChart').parentElement.innerHTML = '<div style="padding:2em;text-align:center;color:#888;">No data yet</div>';
            }
        }

        async function updateGeoMap(events) {
            if (!geoMap) {
                geoMap = L.map('geoMap').setView([0, 0], 1);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: 'Â© OpenStreetMap'
                }).addTo(geoMap);
            }
            // Remove old markers
            geoMarkers.forEach(m => geoMap.removeLayer(m));
            geoMarkers = [];
            const markers = await buildGeoMarkers(events);
            // Always show the map, even if there are no markers
            if (markers.length > 0) {
                markers.forEach(m => {
                    const marker = L.marker([m.lat, m.lng]).addTo(geoMap);
                    marker.bindPopup(m.popup);
                    geoMarkers.push(marker);
                });
            }
        }

        async function fetchStats() {
            try {
                // Always use Fly.io API for stats
                const apiUrl = 'https://backend-weathered-voice-4887.fly.dev/api/stats';
                const response = await fetch(apiUrl);
                if (!response.ok) return;
                const data = await response.json();
                document.getElementById('totalEvents').textContent = data.totalEvents ?? '0';
                document.getElementById('last24h').textContent = data.last24h ?? '0';
                // Top IPs Table
                let ipRows = '';
                (data.topIPs ?? []).forEach(ip => {
                    ipRows += `<tr><td>${ip.ip ?? ''}</td><td>${ip.count ?? ''}</td></tr>`;
                });
                document.querySelector('#topIPs tbody').innerHTML = ipRows;
                // Top Ports Table
                let portRows = '';
                (data.topPorts ?? []).forEach(port => {
                    portRows += `<tr><td>${port.port ?? ''}</td><td>${port.count ?? ''}</td></tr>`;
                });
                document.querySelector('#topPorts tbody').innerHTML = portRows;
                // Recent Events Table
                let eventRows = '';
                (data.recentEvents ?? []).forEach(ev => {
                    // Tag private/internal IPs
                    let ipLabel = '';
                    const ip = ev.ip_display ?? ev.ip ?? '';
                    if (/^127\./.test(ip)) ipLabel = ' <span style="color:#64748b;font-size:0.9em">(internal)</span>';
                    else if (/^192\.168\./.test(ip)) ipLabel = ' <span style="color:#64748b;font-size:0.9em">(LAN)</span>';
                    else if (/^172\.(1[6-9]|2[0-9]|3[0-1])\./.test(ip)) ipLabel = ' <span style="color:#64748b;font-size:0.9em">(Fly internal)</span>';
                    eventRows += `<tr>
                        <td>${ev.timestamp ?? ''}</td>
                        <td>${ip}${ipLabel}</td>
                        <td>${ev.port ?? ''}</td>
                        <td>${ev.src_port ?? ''}</td>
                        <td>${ev.protocol ?? ''}</td>
                        <td>${ev.event_type ?? ''}</td>
                        <td>${ev.message ?? ''}</td>
                        <td>${ev.user_agent ?? ''}</td>
                        <td>${typeof ev.banner_sent === 'boolean' ? String(ev.banner_sent) : ''}</td>
                    </tr>`;
                });
                document.querySelector('#recentEvents tbody').innerHTML = eventRows;

                // Save geoIPs for map rendering
                window.latestGeoIPs = data.geoIPs || [];

                // Update analytics visuals
                updateEventsOverTimeChart(data.recentEvents ?? []);
                updateTopIPsChart(data.topIPs ?? []);
                updateProtocolChart(data.recentEvents ?? []);
                await updateGeoMap(data.recentEvents ?? []);
            } catch (err) {
                // Silent fail for now
            }
        }
        fetchStats();
        setInterval(fetchStats, 5000);
    </script>
</body>
</html>
